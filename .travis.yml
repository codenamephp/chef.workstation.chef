addons:
  apt:
    sources:
      - chef-current-xenial
    packages:
      - chef-workstation

if: sender != "github-actions[bot]"

branches:
  only:
  - master
  - /^\d+\.\d+(\.\d+)?(-\S*)?$/

services: docker

env:
  global:
    - CHEF_LICENSE=accept
    - KITCHEN_LOCAL_YAML=kitchen.dokken.yml

install:
- openssl aes-256-cbc -K $encrypted_0c84fc16f455_key -iv $encrypted_0c84fc16f455_iv -in codenamephp.pem.enc -out codenamephp.pem -d
- sudo iptables -L DOCKER || ( echo "DOCKER iptables chain missing" ; sudo iptables -N DOCKER )
- eval "$(chef shell-init bash)"

script:
  - chef exec foodcritic .
  - chef exec rubocop
  - chef exec rspec
  - chef exec kitchen test

before_deploy:
  - chef exec knife cookbook metadata from file metadata.rb
deploy:
  provider: chef_supermarket
  user_id: "codenamephp"
  client_key: "codenamephp.pem"
  category: "Utilities"
  edge: true
  run:
    - chef exec berks upload -e test
  on:
    tags: true
notifications:
  slack:
    on_success: never
    on_failure: always
    rooms:
      - secure: "fUJx5in/OUC7drYj/q3wLThfjhQLcTtoM3FYqIyQzIrsYMZdkC/T/5Vh9QU1bY7XaBbTqF4n4Sfsqui1NSNyTsgVBhYUzhCPVOuMRCkaj+pS4ahNO2QtSewzDZ01pof7xBMZxI6j/msDrhFz35PLbi31Os2WoiJqxjbjqQBoK7nN+AlYBhh1hJxDNk/1bg2cV5LURd0JpM1ih4PwYWWrECDrchlykOAydQ76KIw9M0K9BuGXWwOh6dm6Xk3yGrgFgT1VqzKJ3Fdv6oi2WKWQoWH6LvMDvGWQvuMPswow2jv85jtCk+r50NMYx/F6wkWypD9Tr6/7NFeeIhrMCMQ7hjFLhwhXF+9PEFq5Ns6FYboL1vQuWZ0eXfP5MpNffIe+nRmnNtrBa5rOnvn4fsHp5tB5kLFFfh6kUwZsaQbeLkPydAX6Le9tCgtqTM0G336Mq3xKJQToZTGVgtW5R6wp2VmmCvO4GGlGPHj2l89tIVZn3YjtBALCKqiUGvjlfzRR4B8cqyc5HoZGJ0+/gPd3olY6fHKd51oMIr5Ss/wuXnDRWhEPpIfn1T+yrWmvZBSkA2UcY4dapkirON52INQIDjOSdtE62ba81nhF+uVG6dusUq6n+TojxngTpimFbfEpYMQfRJfK5JLsP/9QprLGATNSBODlb3bidVNqJRZMurI="
